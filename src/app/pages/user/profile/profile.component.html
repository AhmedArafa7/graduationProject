<div class="flex min-h-screen font-display" dir="rtl">
  
  <!-- Shared Sidebar (للجميع) -->
  <app-agent-sidebar [currentPage]="'profile'" />

  <!-- Main Content -->
  <main class="mr-64 flex-1 p-8 bg-background-light dark:bg-background-dark min-h-screen">
    <div class="max-w-screen-xl mx-auto">

      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-black text-text-primary dark:text-white mb-2">ملفي الشخصي</h1>
        <p class="text-text-secondary dark:text-gray-400">إدارة معلوماتك الشخصية ومعلومات الوكيل</p>
      </div>

      <!-- Profile Card -->
      <div class="bg-card-background dark:bg-gray-800 rounded-2xl border border-border-color dark:border-gray-700 p-6 md:p-8 mb-8 shadow-sm">
        <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
          
          <!-- Profile Image -->
          <div class="relative group">
            <input type="file" #fileInput accept="image/*" (change)="onImageSelected($event)" class="hidden">
            <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-white dark:border-gray-700 shadow-lg cursor-pointer" 
                 (click)="triggerFileInput(fileInput)">
              <img [src]="profileImage()" alt="صورة شخصية" class="w-full h-full object-cover">
              <!-- Overlay on hover -->
              @if (isEditing()) {
                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full">
                  <span class="material-symbols-outlined text-white text-3xl">photo_camera</span>
                </div>
              }
            </div>
          </div>

          <!-- User Info -->
          <div class="flex-1 text-center md:text-right">
            <h2 class="text-2xl font-bold text-text-primary dark:text-white mb-1">
              {{ personalInfo().firstName }} {{ personalInfo().lastName }}
            </h2>
            <p class="text-text-secondary dark:text-gray-400 mb-1">{{ personalInfo().email }}</p>
            <p class="text-xs text-secondary font-bold mb-4">{{ isAgent() ? 'وكيل عقاري' : 'مشتري' }}</p>
            
            <button (click)="toggleEdit()" 
                    class="px-6 py-2.5 bg-secondary hover:bg-secondary/90 text-white font-bold text-sm rounded-lg transition-all shadow-md cursor-pointer">
              @if (isEditing()) {
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">close</span>
                  إلغاء التعديل
                </span>
              } @else {
                <span class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-lg">edit</span>
                  تعديل الملف
                </span>
              }
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-card-background dark:bg-gray-800 rounded-2xl border border-border-color dark:border-gray-700 shadow-sm overflow-hidden">
        
        <!-- Tab Headers -->
        <div class="flex border-b border-border-color dark:border-gray-700">
          <button (click)="setActiveTab('personal')"
                  class="flex-1 md:flex-none px-6 py-4 text-sm font-bold transition-all cursor-pointer"
                  [class]="activeTab() === 'personal' 
                    ? 'text-primary border-b-2 border-primary bg-primary/5' 
                    : 'text-text-secondary dark:text-gray-400 hover:text-primary hover:bg-gray-50 dark:hover:bg-gray-700'">
            <span class="flex items-center justify-center gap-2">
              <span class="material-symbols-outlined text-lg">person</span>
              المعلومات الشخصية
            </span>
          </button>
          @if (isAgent()) {
            <button (click)="setActiveTab('agent')"
                    class="flex-1 md:flex-none px-6 py-4 text-sm font-bold transition-all cursor-pointer"
                    [class]="activeTab() === 'agent' 
                      ? 'text-primary border-b-2 border-primary bg-primary/5' 
                      : 'text-text-secondary dark:text-gray-400 hover:text-primary hover:bg-gray-50 dark:hover:bg-gray-700'">
              <span class="flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-lg">real_estate_agent</span>
                معلومات الوكيل
              </span>
            </button>
          }
        </div>

        <!-- Tab Content -->
        <div class="p-6 md:p-8">
          
          <!-- Personal Information Tab -->
          @if (activeTab() === 'personal') {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              
              <!-- First Name -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">الاسم الأول</label>
                <input [ngModel]="personalInfo().firstName" 
                       (ngModelChange)="updateFirstName($event)"
                       [disabled]="!isEditing()"
                       type="text"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="أدخل الاسم الأول">
              </div>

              <!-- Last Name -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">الاسم الأخير</label>
                <input [ngModel]="personalInfo().lastName" 
                       (ngModelChange)="updateLastName($event)"
                       [disabled]="!isEditing()"
                       type="text"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="أدخل الاسم الأخير">
              </div>

              <!-- Email -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">البريد الإلكتروني</label>
                <input [ngModel]="personalInfo().email" 
                       (ngModelChange)="updateEmail($event)"
                       [disabled]="!isEditing()"
                       type="email"
                       dir="ltr"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 text-right focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="example@email.com">
              </div>

              <!-- Phone -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">رقم الهاتف</label>
                <div class="flex w-full h-12 rounded-lg border overflow-hidden bg-gray-50 dark:bg-gray-700"
                     [class.border-gray-200]="!isEditing()"
                     [class.dark:border-gray-600]="!isEditing()"
                     [class.border-primary]="isEditing()"
                     dir="ltr">
                  <div class="bg-gray-100 dark:bg-gray-600 flex items-center justify-center px-4 text-text-secondary dark:text-gray-200 font-bold text-sm border-r border-gray-200 dark:border-gray-500">
                    +20
                  </div>
                  <input [ngModel]="personalInfo().phone" 
                         (ngModelChange)="updatePhone($event)"
                         [disabled]="!isEditing()"
                         type="tel"
                         class="flex-1 h-full px-4 border-none bg-transparent text-text-primary dark:text-white focus:ring-0 outline-none text-right placeholder:text-gray-400 disabled:opacity-60 disabled:cursor-not-allowed"
                         placeholder="01xxxxxxxxx"
                         maxlength="11">
                </div>
              </div>
            </div>
          }

          <!-- Agent Information Tab -->
          @if (activeTab() === 'agent') {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              
              <!-- License Number -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">رقم الترخيص</label>
                <input [ngModel]="agentInfo().licenseNumber" 
                       (ngModelChange)="updateLicenseNumber($event)"
                       [disabled]="!isEditing()"
                       type="text"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="أدخل رقم الترخيص">
              </div>

              <!-- Company -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">اسم الشركة</label>
                <input [ngModel]="agentInfo().company" 
                       (ngModelChange)="updateCompany($event)"
                       [disabled]="!isEditing()"
                       type="text"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="أدخل اسم الشركة">
              </div>

              <!-- Experience -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">سنوات الخبرة</label>
                <input [ngModel]="agentInfo().experience" 
                       (ngModelChange)="updateExperience($event)"
                       [disabled]="!isEditing()"
                       type="text"
                       class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed"
                       [class.border-gray-200]="!isEditing()"
                       [class.dark:border-gray-600]="!isEditing()"
                       [class.border-primary]="isEditing()"
                       placeholder="مثال: 5 سنوات">
              </div>

              <!-- Specialization -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">التخصص</label>
                <select [ngModel]="agentInfo().specialization" 
                        (ngModelChange)="updateSpecialization($event)"
                        [disabled]="!isEditing()"
                        class="w-full h-12 px-4 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none disabled:opacity-60 disabled:cursor-not-allowed cursor-pointer"
                        [class.border-gray-200]="!isEditing()"
                        [class.dark:border-gray-600]="!isEditing()"
                        [class.border-primary]="isEditing()">
                  <option value="">اختر التخصص</option>
                  <option value="residential">عقارات سكنية</option>
                  <option value="commercial">عقارات تجارية</option>
                  <option value="land">أراضي</option>
                  <option value="rental">تأجير</option>
                </select>
              </div>

              <!-- Bio -->
              <div class="space-y-2 md:col-span-2">
                <label class="block text-sm font-medium text-text-secondary dark:text-gray-300">نبذة عنك</label>
                <textarea [ngModel]="agentInfo().bio" 
                          (ngModelChange)="updateBio($event)"
                          [disabled]="!isEditing()"
                          rows="4"
                          class="w-full px-4 py-3 rounded-lg border bg-gray-50 dark:bg-gray-700 text-text-primary dark:text-white transition-all placeholder:text-gray-400 focus:bg-white dark:focus:bg-gray-800 focus:ring-2 focus:ring-primary/50 outline-none resize-none disabled:opacity-60 disabled:cursor-not-allowed"
                          [class.border-gray-200]="!isEditing()"
                          [class.dark:border-gray-600]="!isEditing()"
                          [class.border-primary]="isEditing()"
                          placeholder="اكتب نبذة مختصرة عنك وخبراتك..."></textarea>
              </div>
            </div>
          }

          <!-- Action Buttons -->
          @if (isEditing()) {
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 mt-8 pt-6 border-t border-border-color dark:border-gray-700">
              <button (click)="cancelChanges()" 
                      class="px-6 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-text-primary dark:text-white font-bold text-sm rounded-lg transition-all cursor-pointer">
                إلغاء
              </button>
              <button (click)="saveChanges()" 
                      class="px-6 py-3 bg-secondary hover:bg-secondary/90 text-white font-bold text-sm rounded-lg transition-all shadow-md cursor-pointer flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-lg">save</span>
                حفظ التغييرات
              </button>
            </div>
          }
        </div>
      </div>

    </div>
  </main>
</div>
