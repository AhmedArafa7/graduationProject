<div class="flex h-screen font-display" dir="rtl">
  
  <!-- Sidebar -->
  <app-agent-sidebar [currentPage]="'messages'" />

  <!-- Main Content -->
  <main class="mr-64 flex-1 flex h-screen">
    
    <!-- Conversations List Panel -->
    <div class="w-[380px] border-l border-border-color dark:border-gray-700 bg-card-background dark:bg-gray-800 flex flex-col">
      
      <!-- Header -->
      <div class="p-4 border-b border-border-color dark:border-gray-700">
        <h2 class="text-xl font-bold text-text-primary dark:text-white">رسائلي</h2>
        
        <!-- Search -->
        <div class="mt-4">
          <div class="flex w-full h-11 rounded-lg overflow-hidden bg-background-light dark:bg-gray-700">
            <div class="flex items-center justify-center px-3 text-text-secondary dark:text-gray-400">
              <span class="material-symbols-outlined">search</span>
            </div>
            <input [ngModel]="searchQuery()" 
                   (ngModelChange)="searchQuery.set($event)"
                   type="text"
                   placeholder="ابحث بالاسم أو الكلمة..."
                   class="flex-1 bg-transparent border-none outline-none text-text-primary dark:text-white placeholder:text-text-secondary text-sm" />
          </div>
        </div>
      </div>

      <!-- Conversations List -->
      <div class="flex-1 overflow-y-auto">
        @for (conv of filteredConversations(); track conv.id) {
          <div (click)="selectConversation(conv)"
               class="group relative flex items-center gap-4 px-4 py-3 cursor-pointer border-b border-border-color dark:border-gray-700 transition-colors"
               [class.bg-primary-10]="selectedConversation()?.id === conv.id"
               [class.hover:bg-gray-50]="selectedConversation()?.id !== conv.id"
               [class.dark:hover:bg-gray-700]="selectedConversation()?.id !== conv.id">
            
            <div class="relative">
              <img [src]="conv.avatar" [alt]="conv.name" class="w-12 h-12 rounded-full object-cover" />
              @if (conv.online) {
                <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></span>
              }
            </div>

            <div class="flex-1 min-w-0">
              <p class="font-medium text-text-primary dark:text-white truncate">{{ conv.name }}</p>
              <p class="text-sm truncate" 
                 [class.text-primary]="conv.unread"
                 [class.font-semibold]="conv.unread"
                 [class.text-text-secondary]="!conv.unread">
                {{ conv.lastMessage }}
              </p>
            </div>

            <div class="flex flex-col items-end gap-1 shrink-0">
              <span class="text-xs text-text-secondary dark:text-gray-400">{{ conv.time }}</span>
              @if (conv.unread) {
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
              }
            </div>

            <!-- Delete button -->
            <button (click)="deleteConversation(conv, $event)"
                    class="absolute top-2 left-2 p-1 rounded-full bg-gray-200/50 dark:bg-gray-600/50 text-text-secondary opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
              <span class="material-symbols-outlined text-lg">delete</span>
            </button>
          </div>
        }

        @if (filteredConversations().length === 0) {
          <div class="text-center py-12 text-text-secondary">
            <span class="material-symbols-outlined text-4xl mb-2">forum</span>
            <p>لا توجد محادثات</p>
          </div>
        }
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="flex-1 flex flex-col bg-background-light dark:bg-background-dark">
      
      @if (selectedConversation()) {
        <!-- Chat Header -->
        <header class="flex items-center gap-4 p-4 border-b border-border-color dark:border-gray-700 bg-card-background dark:bg-gray-800">
          <img [src]="selectedConversation()!.avatar" [alt]="selectedConversation()!.name" class="w-10 h-10 rounded-full object-cover" />
          <div>
            <h3 class="font-bold text-text-primary dark:text-white">{{ selectedConversation()!.name }}</h3>
            @if (selectedConversation()!.online) {
              <p class="text-sm text-green-500">متصل الآن</p>
            }
          </div>
        </header>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
          @for (msg of currentMessages(); track msg.id) {
            <div class="flex" [class.justify-end]="msg.sender === 'user'" [class.justify-start]="msg.sender === 'other'">
              <div class="max-w-md">
                
                <!-- Attachment Message -->
                @if (msg.attachment) {
                  <div class="rounded-2xl shadow-sm overflow-hidden"
                       [class.bg-primary]="msg.sender === 'user'"
                       [class.bg-card-background]="msg.sender === 'other'"
                       [class.dark:bg-gray-700]="msg.sender === 'other'">
                    
                    <!-- Image Attachment -->
                    @if (msg.attachment.type === 'image' && msg.attachment.url) {
                      <img [src]="msg.attachment.url" [alt]="msg.attachment.name" class="max-w-full rounded-t-2xl" />
                    }
                    
                    <!-- File Info Card -->
                    <div class="flex items-center gap-3 p-3"
                         [class.border-t]="msg.attachment.type === 'image'"
                         [class.border-white]="msg.sender === 'user' && msg.attachment.type === 'image'"
                         [class.border-opacity-20]="msg.sender === 'user'">
                      <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                           [ngClass]="msg.sender === 'user' ? 'bg-white/20' : 'bg-gray-100 dark:bg-gray-600'">
                        <span class="material-symbols-outlined"
                              [class.text-white]="msg.sender === 'user'"
                              [class.text-primary]="msg.sender === 'other'">
                          {{ getFileIcon(msg.attachment.type) }}
                        </span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate"
                           [class.text-white]="msg.sender === 'user'"
                           [class.text-text-primary]="msg.sender === 'other'"
                           [class.dark:text-white]="msg.sender === 'other'">
                          {{ msg.attachment.name }}
                        </p>
                        <p class="text-xs"
                           [ngClass]="msg.sender === 'user' ? 'text-white/70' : 'text-text-secondary'">
                          {{ msg.attachment.size }}
                        </p>
                      </div>
                    </div>
                  </div>
                } @else {
                  <!-- Text Message -->
                  <div class="p-3 rounded-2xl shadow-sm"
                       [class.bg-primary]="msg.sender === 'user'"
                       [class.text-white]="msg.sender === 'user'"
                       [class.rounded-bl-none]="msg.sender === 'other'"
                       [class.rounded-br-none]="msg.sender === 'user'"
                       [class.bg-card-background]="msg.sender === 'other'"
                       [class.dark:bg-gray-700]="msg.sender === 'other'"
                       [class.text-text-primary]="msg.sender === 'other'"
                       [class.dark:text-white]="msg.sender === 'other'">
                    <p class="text-sm leading-relaxed">{{ msg.text }}</p>
                  </div>
                }
                
                <p class="text-xs text-text-secondary dark:text-gray-400 mt-1"
                   [class.text-left]="msg.sender === 'other'"
                   [class.text-right]="msg.sender === 'user'">
                  {{ msg.time }}
                </p>
              </div>
            </div>
          }
        </div>

        <!-- Message Input -->
        <footer class="p-4 bg-card-background dark:bg-gray-800 border-t border-border-color dark:border-gray-700">
          <div class="flex items-center gap-2">
            <input type="file" #fileInput (change)="onFileSelected($event)" class="hidden" accept="image/*,.pdf,.doc,.docx" />
            <button (click)="fileInput.click()" 
                    class="flex items-center justify-center rounded-lg h-11 w-11 text-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer"
                    title="إرفاق ملف">
              <span class="material-symbols-outlined">attach_file</span>
            </button>
            <input #messageInput
                   [ngModel]="newMessage()"
                   (ngModelChange)="newMessage.set($event)"
                   (keyup.enter)="sendMessage()"
                   type="text"
                   placeholder="اكتب رسالتك..."
                   autofocus
                   class="flex-1 h-11 px-4 rounded-lg border border-border-color dark:border-gray-600 bg-background-light dark:bg-gray-700 text-text-primary dark:text-white placeholder:text-text-secondary outline-none focus:ring-2 focus:ring-primary/50" />
            <button (click)="sendMessage()"
                    class="flex items-center justify-center rounded-lg h-11 w-11 bg-primary text-white hover:bg-primary/90 transition-colors cursor-pointer">
              <span class="material-symbols-outlined">send</span>
            </button>
          </div>
        </footer>
      } @else {
        <!-- No conversation selected -->
        <div class="flex-1 flex items-center justify-center text-text-secondary">
          <div class="text-center">
            <span class="material-symbols-outlined text-6xl mb-4">chat</span>
            <p class="text-lg">اختر محادثة للبدء</p>
          </div>
        </div>
      }
    </div>

  </main>
</div>
