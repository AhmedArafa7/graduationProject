<div class="fixed bottom-6 left-6 z-50 font-display">
  
  <div class="absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-4 py-2 bg-text-primary text-white text-sm font-bold rounded-lg whitespace-nowrap opacity-0 hover:opacity-100 transition-opacity duration-300 pointer-events-none shadow-lg">
    مساعدك الذكي
    <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-text-primary"></div>
  </div>

  <button (click)="toggleChat()" 
          class="relative flex items-center justify-center w-16 h-16 bg-secondary hover:bg-secondary/90 text-white rounded-full shadow-2xl transition-transform hover:scale-110 active:scale-95">
    @if (!chatbotService.isOpen()) {
      <span class="material-symbols-outlined text-3xl animate-bounce-slow">smart_toy</span>
    } @else {
      <span class="material-symbols-outlined text-3xl">close</span>
    }
    <span class="absolute top-0 right-0 block w-4 h-4 bg-green-500 border-2 border-white dark:border-background-dark rounded-full"></span>
  </button>
</div>

<div [class.translate-y-[150%]]="!chatbotService.isOpen()"
     [class.translate-y-0]="chatbotService.isOpen()"
     class="fixed bottom-24 left-4 md:left-6 z-50 w-[90vw] md:w-[400px] h-[600px] max-h-[80vh] bg-background-light dark:bg-background-dark rounded-2xl shadow-2xl border border-border-color dark:border-gray-700 flex flex-col transition-transform duration-500 ease-in-out overflow-hidden font-display">

  <header class="flex items-center justify-between p-4 bg-gradient-to-r from-primary to-[#4e5da7] text-white flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm">
        <span class="material-symbols-outlined text-2xl">smart_toy</span>
      </div>
      <div>
        <h2 class="text-base font-bold">مساعد Baytology</h2>
        <div class="flex items-center gap-1.5">
          <span class="block w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
          <p class="text-xs text-green-100 font-medium">متصل الآن</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-1">
      <button (click)="toggleChat()" class="p-2 rounded-full hover:bg-white/20 transition-colors">
        <span class="material-symbols-outlined text-xl">minimize</span>
      </button>
    </div>
  </header>

  <main #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-white dark:bg-[#15171e]">
    
    @for (msg of messages(); track msg.id) {
      
      @if (msg.sender === 'bot') {
        <div class="flex items-end gap-3 animate-fadeIn">
          <div class="bg-primary/10 dark:bg-primary/20 text-primary dark:text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
            <span class="material-symbols-outlined text-lg">smart_toy</span>
          </div>
          <div class="flex flex-col gap-1 max-w-[80%]">
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mr-1">Baytology</span>
            
            @if (msg.type === 'text') {
              <div class="px-4 py-3 bg-background-light dark:bg-gray-800 text-text-primary dark:text-gray-200 rounded-2xl rounded-br-none text-sm leading-relaxed shadow-sm border border-border-color dark:border-gray-700">
                {{ msg.text }}
              </div>
            } 
            
            @if (msg.type === 'property') {
              <div class="bg-card-background dark:bg-gray-800 rounded-xl shadow-sm border border-border-color dark:border-gray-700 overflow-hidden w-64">
                <img [src]="msg.data.image" class="w-full h-32 object-cover" alt="Property">
                <div class="p-3">
                  <h4 class="font-bold text-text-primary dark:text-white text-sm line-clamp-1">{{ msg.data.title }}</h4>
                  <p class="text-secondary font-bold text-sm mt-1">{{ msg.data.price }}</p>
                  <p class="text-xs text-text-secondary dark:text-gray-400 mt-1 flex items-center gap-1">
                    <span class="material-symbols-outlined text-[10px]">info</span> {{ msg.data.specs }}
                  </p>
                  <button class="w-full mt-3 py-1.5 bg-primary text-white text-xs font-bold rounded-lg hover:bg-primary/90 transition-colors">
                    التفاصيل
                  </button>
                </div>
              </div>
            }
            
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mt-1 mr-1">{{ msg.time }}</span>
          </div>
        </div>
      }

      @if (msg.sender === 'user') {
        <div class="flex items-end gap-3 justify-end animate-fadeIn">
          <div class="flex flex-col gap-1 items-end max-w-[80%]">
            <div class="px-4 py-3 bg-primary text-white rounded-2xl rounded-bl-none text-sm leading-relaxed shadow-md">
              {{ msg.text }}
            </div>
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mt-1 ml-1">{{ msg.time }}</span>
          </div>
          <div class="bg-gray-200 dark:bg-gray-700 w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-white dark:border-gray-600">
            <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuC3OjpZpC0y-nrmeaDuj5SN0y4rP2t_vDFHLJf75APiFJgDGG7n-Da9M31SA44K2xNJ7L-0p6_pHrRXCoGDWDQYLwa95oLWk5twu02uXBG9ZRt_Aw5ItWuwF9pWC3fC5L9uPp8_hipUAmU8w66lZawijSdfqqPdM4usxUOEaNAVvon0VWun5YeQw5KWZDwuaA87r8PZzj7_a3Xxlm2NY1EDWsVnhcnNZzXMDChEAq2bnHxMBMD8dcG0BrZdnI5E_tWEZczmkEJyIjQ" class="w-full h-full object-cover" alt="User">
          </div>
        </div>
      }

    }

    @if (isTyping()) {
      <div class="flex items-end gap-3 animate-fadeIn">
        <div class="bg-primary/10 dark:bg-primary/20 text-primary dark:text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-lg">smart_toy</span>
        </div>
        <div class="px-4 py-3 bg-background-light dark:bg-gray-800 rounded-2xl rounded-br-none shadow-sm border border-border-color dark:border-gray-700">
          <div class="flex gap-1">
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce" style="animation-delay: -0.3s"></span>
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce" style="animation-delay: -0.15s"></span>
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce"></span>
          </div>
        </div>
      </div>
    }

  </main>

  <footer class="p-4 bg-white dark:bg-[#1F212A] border-t border-border-color dark:border-gray-700 flex-shrink-0">
    
    @if (messages().length < 3) {
      <div class="flex gap-2 mb-3 overflow-x-auto pb-2 no-scrollbar">
        @for (reply of quickReplies; track reply) {
          <button (click)="sendMessage(reply)" 
                  class="flex-shrink-0 px-3 py-1.5 bg-background-light dark:bg-gray-800 border border-border-color dark:border-gray-600 rounded-full text-xs font-bold text-text-secondary hover:text-primary hover:border-primary hover:bg-primary/5 transition-all whitespace-nowrap">
            {{ reply }}
          </button>
        }
      </div>
    }

    <div class="relative flex items-center gap-2">
      <button class="p-2 text-text-secondary hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
        <span class="material-symbols-outlined text-xl">mic</span>
      </button>
      
      <input 
        [(ngModel)]="inputText" 
        (keyup.enter)="sendMessage()"
        type="text" 
        class="flex-1 bg-background-light dark:bg-gray-900 border border-border-color dark:border-gray-600 rounded-xl px-4 py-2.5 text-sm text-text-primary dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all placeholder:text-text-secondary"
        placeholder="اكتب رسالتك هنا..."
      >
      
      <button (click)="sendMessage()" 
              [disabled]="!inputText().trim()"
              class="p-2 bg-primary text-white rounded-xl hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
        <span class="material-symbols-outlined text-xl rtl:rotate-180">send</span>
      </button>
    </div>
  </footer>

</div>