<div class="fixed bottom-6 left-6 z-50 font-display">
  
  <div class="absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-4 py-2 bg-text-primary text-white text-sm font-bold rounded-lg whitespace-nowrap opacity-0 hover:opacity-100 transition-opacity duration-300 pointer-events-none shadow-lg">
    مساعدك الذكي
    <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-text-primary"></div>
  </div>

  <button (click)="toggleChat()" 
          class="relative flex items-center justify-center w-16 h-16 bg-secondary hover:bg-secondary/90 text-white rounded-full shadow-2xl transition-transform hover:scale-110 active:scale-95">
    @if (!chatbotService.isOpen()) {
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200" width="80%" height="80%">
  
  <defs>
    <linearGradient id="trendyMix" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00c6ff; stop-opacity:1" />
      <stop offset="33%" style="stop-color:#9600ff; stop-opacity:1" />
      <stop offset="66%" style="stop-color:#ff0078; stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffb700; stop-opacity:1" />
    </linearGradient>
  </defs>

  <path d="M493.667 229.267C508.369 309.65 547.369 384.411 607.51 444.843C667.652 505.275 742.028 544.396 822.126 559.008C742.028 573.621 667.652 612.741 607.51 673.173C547.369 733.605 508.369 808.367 493.667 888.75C478.964 808.367 439.964 733.605 379.823 673.173C319.682 612.741 245.306 573.621 165.208 559.008C245.306 544.396 319.682 505.275 379.823 444.843C439.964 384.411 478.964 309.65 493.667 229.267Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 77.902C879.591 115.091 897.634 149.678 925.457 177.635C953.28 205.592 987.689 223.691 1024.74 230.451C987.689 237.211 953.28 255.31 925.457 283.267C897.634 311.224 879.591 345.811 872.791 383C865.991 345.811 847.948 311.224 820.125 283.267C792.303 255.31 757.893 237.211 720.842 230.451C757.893 223.691 792.303 205.592 820.125 177.635C847.948 149.678 865.991 115.091 872.791 77.902Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 792.322C879.591 829.511 897.634 864.098 925.457 892.055C953.28 920.012 987.689 938.111 1024.74 944.871C987.689 951.631 953.28 969.73 925.457 997.687C897.634 1025.64 879.591 1060.23 872.791 1097.42C865.991 1060.23 847.948 1025.64 820.125 997.687C792.303 969.73 757.893 951.631 720.842 944.871C757.893 938.111 792.303 920.012 820.125 892.055C847.948 864.098 865.991 829.511 872.791 792.322Z" fill="url(#trendyMix)"/>
</svg>
    } @else {
      <span class="material-symbols-outlined text-3xl">close</span>
    }
    <span class="absolute top-0 right-0 block w-4 h-4 bg-green-500 border-2 border-white dark:border-background-dark rounded-full"></span>
  </button>
</div>

<div [class.translate-y-[150%]]="!chatbotService.isOpen()"
     [class.translate-y-0]="chatbotService.isOpen()"
     class="fixed bottom-24 left-4 md:left-6 z-50 w-[90vw] md:w-[400px] h-[600px] max-h-[80vh] bg-background-light dark:bg-background-dark rounded-2xl shadow-2xl border border-border-color dark:border-gray-700 flex flex-col transition-transform duration-500 ease-in-out overflow-hidden font-display">

  <header class="flex items-center justify-between p-4 bg-gradient-to-r from-primary to-[#4e5da7] text-white flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200" width="80%" height="80%">
  
  <defs>
    <linearGradient id="trendyMix" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00c6ff; stop-opacity:1" />
      <stop offset="33%" style="stop-color:#9600ff; stop-opacity:1" />
      <stop offset="66%" style="stop-color:#ff0078; stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffb700; stop-opacity:1" />
    </linearGradient>
  </defs>

  <path d="M493.667 229.267C508.369 309.65 547.369 384.411 607.51 444.843C667.652 505.275 742.028 544.396 822.126 559.008C742.028 573.621 667.652 612.741 607.51 673.173C547.369 733.605 508.369 808.367 493.667 888.75C478.964 808.367 439.964 733.605 379.823 673.173C319.682 612.741 245.306 573.621 165.208 559.008C245.306 544.396 319.682 505.275 379.823 444.843C439.964 384.411 478.964 309.65 493.667 229.267Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 77.902C879.591 115.091 897.634 149.678 925.457 177.635C953.28 205.592 987.689 223.691 1024.74 230.451C987.689 237.211 953.28 255.31 925.457 283.267C897.634 311.224 879.591 345.811 872.791 383C865.991 345.811 847.948 311.224 820.125 283.267C792.303 255.31 757.893 237.211 720.842 230.451C757.893 223.691 792.303 205.592 820.125 177.635C847.948 149.678 865.991 115.091 872.791 77.902Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 792.322C879.591 829.511 897.634 864.098 925.457 892.055C953.28 920.012 987.689 938.111 1024.74 944.871C987.689 951.631 953.28 969.73 925.457 997.687C897.634 1025.64 879.591 1060.23 872.791 1097.42C865.991 1060.23 847.948 1025.64 820.125 997.687C792.303 969.73 757.893 951.631 720.842 944.871C757.893 938.111 792.303 920.012 820.125 892.055C847.948 864.098 865.991 829.511 872.791 792.322Z" fill="url(#trendyMix)"/>
</svg>
      </div>
      <div>
        <h2 class="text-base font-bold">مساعد Baytology</h2>
        <div class="flex items-center gap-1.5">
          <span class="block w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
          <p class="text-xs text-green-100 font-medium">متصل الآن</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-1">
      <button (click)="toggleChat()" class="p-2 rounded-full hover:bg-white/20 transition-colors">
        <span class="material-symbols-outlined text-xl">minimize</span>
      </button>
    </div>
  </header>

  <main #scrollContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-white dark:bg-[#15171e]">
    
    @for (msg of messages(); track msg.id) {
      
      @if (msg.sender === 'bot') {
        <div class="flex items-end gap-3 animate-fadeIn">
          <div class="bg-primary/10 dark:bg-primary/20 text-primary dark:text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200" width="80%" height="80%">
  
  <defs>
    <linearGradient id="trendyMix" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00c6ff; stop-opacity:1" />
      <stop offset="33%" style="stop-color:#9600ff; stop-opacity:1" />
      <stop offset="66%" style="stop-color:#ff0078; stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffb700; stop-opacity:1" />
    </linearGradient>
  </defs>

  <path d="M493.667 229.267C508.369 309.65 547.369 384.411 607.51 444.843C667.652 505.275 742.028 544.396 822.126 559.008C742.028 573.621 667.652 612.741 607.51 673.173C547.369 733.605 508.369 808.367 493.667 888.75C478.964 808.367 439.964 733.605 379.823 673.173C319.682 612.741 245.306 573.621 165.208 559.008C245.306 544.396 319.682 505.275 379.823 444.843C439.964 384.411 478.964 309.65 493.667 229.267Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 77.902C879.591 115.091 897.634 149.678 925.457 177.635C953.28 205.592 987.689 223.691 1024.74 230.451C987.689 237.211 953.28 255.31 925.457 283.267C897.634 311.224 879.591 345.811 872.791 383C865.991 345.811 847.948 311.224 820.125 283.267C792.303 255.31 757.893 237.211 720.842 230.451C757.893 223.691 792.303 205.592 820.125 177.635C847.948 149.678 865.991 115.091 872.791 77.902Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 792.322C879.591 829.511 897.634 864.098 925.457 892.055C953.28 920.012 987.689 938.111 1024.74 944.871C987.689 951.631 953.28 969.73 925.457 997.687C897.634 1025.64 879.591 1060.23 872.791 1097.42C865.991 1060.23 847.948 1025.64 820.125 997.687C792.303 969.73 757.893 951.631 720.842 944.871C757.893 938.111 792.303 920.012 820.125 892.055C847.948 864.098 865.991 829.511 872.791 792.322Z" fill="url(#trendyMix)"/>
</svg>
          </div>
          <div class="flex flex-col gap-1 max-w-[80%]">
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mr-1">Baytology</span>
            
            @if (msg.type === 'text') {
              <div class="px-4 py-3 bg-background-light dark:bg-gray-800 text-text-primary dark:text-gray-200 rounded-2xl rounded-br-none text-sm leading-relaxed shadow-sm border border-border-color dark:border-gray-700">
                {{ msg.text }}
              </div>
            } 
            
            @if (msg.type === 'property') {
              <div class="bg-card-background dark:bg-gray-800 rounded-xl shadow-sm border border-border-color dark:border-gray-700 overflow-hidden w-64">
                <img [src]="msg.data.image" class="w-full h-32 object-cover" alt="Property">
                <div class="p-3">
                  <h4 class="font-bold text-text-primary dark:text-white text-sm line-clamp-1">{{ msg.data.title }}</h4>
                  <p class="text-secondary font-bold text-sm mt-1">{{ msg.data.price }}</p>
                  <p class="text-xs text-text-secondary dark:text-gray-400 mt-1 flex items-center gap-1">
                    <span class="material-symbols-outlined text-[10px]">info</span> {{ msg.data.specs }}
                  </p>
                  <button (click)="viewPropertyDetails(msg.data)" class="w-full mt-3 py-1.5 bg-primary text-white text-xs font-bold rounded-lg hover:bg-primary/90 transition-colors cursor-pointer">
                    التفاصيل
                  </button>
                </div>
              </div>
            }
            
            @if (msg.type === 'question') {
              <div class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl rounded-br-none text-sm leading-relaxed shadow-sm">
                {{ msg.text }}
              </div>
            }
            
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mt-1 mr-1">{{ msg.time }}</span>
          </div>
        </div>
      }

      @if (msg.sender === 'user') {
        <div class="flex items-end gap-3 justify-end animate-fadeIn">
          <div class="flex flex-col gap-1 items-end max-w-[80%]">
            <div class="px-4 py-3 bg-primary text-white rounded-2xl rounded-bl-none text-sm leading-relaxed shadow-md">
              {{ msg.text }}
            </div>
            <span class="text-[10px] text-text-secondary dark:text-gray-500 mt-1 ml-1">{{ msg.time }}</span>
          </div>
          <div class="bg-gray-200 dark:bg-gray-700 w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-white dark:border-gray-600">
            <img [src]="userAvatar()" class="w-full h-full object-cover" alt="User">
          </div>
        </div>
      }

    }

    @if (isTyping()) {
      <div class="flex items-end gap-3 animate-fadeIn">
        <div class="bg-primary/10 dark:bg-primary/20 text-primary dark:text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1200" width="80%" height="80%">
  
  <defs>
    <linearGradient id="trendyMix" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00c6ff; stop-opacity:1" />
      <stop offset="33%" style="stop-color:#9600ff; stop-opacity:1" />
      <stop offset="66%" style="stop-color:#ff0078; stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffb700; stop-opacity:1" />
    </linearGradient>
  </defs>

  <path d="M493.667 229.267C508.369 309.65 547.369 384.411 607.51 444.843C667.652 505.275 742.028 544.396 822.126 559.008C742.028 573.621 667.652 612.741 607.51 673.173C547.369 733.605 508.369 808.367 493.667 888.75C478.964 808.367 439.964 733.605 379.823 673.173C319.682 612.741 245.306 573.621 165.208 559.008C245.306 544.396 319.682 505.275 379.823 444.843C439.964 384.411 478.964 309.65 493.667 229.267Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 77.902C879.591 115.091 897.634 149.678 925.457 177.635C953.28 205.592 987.689 223.691 1024.74 230.451C987.689 237.211 953.28 255.31 925.457 283.267C897.634 311.224 879.591 345.811 872.791 383C865.991 345.811 847.948 311.224 820.125 283.267C792.303 255.31 757.893 237.211 720.842 230.451C757.893 223.691 792.303 205.592 820.125 177.635C847.948 149.678 865.991 115.091 872.791 77.902Z" fill="url(#trendyMix)"/>
  
  <path d="M872.791 792.322C879.591 829.511 897.634 864.098 925.457 892.055C953.28 920.012 987.689 938.111 1024.74 944.871C987.689 951.631 953.28 969.73 925.457 997.687C897.634 1025.64 879.591 1060.23 872.791 1097.42C865.991 1060.23 847.948 1025.64 820.125 997.687C792.303 969.73 757.893 951.631 720.842 944.871C757.893 938.111 792.303 920.012 820.125 892.055C847.948 864.098 865.991 829.511 872.791 792.322Z" fill="url(#trendyMix)"/>
</svg>
        </div>
        <div class="px-4 py-3 bg-background-light dark:bg-gray-800 rounded-2xl rounded-br-none shadow-sm border border-border-color dark:border-gray-700">
          <div class="flex gap-1">
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce" style="animation-delay: -0.3s"></span>
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce" style="animation-delay: -0.15s"></span>
            <span class="w-2 h-2 bg-text-secondary/50 rounded-full animate-bounce"></span>
          </div>
        </div>
      </div>
    }

  </main>

  <footer class="p-4 bg-white dark:bg-[#1F212A] border-t border-border-color dark:border-gray-700 flex-shrink-0">
    
    @if (messages().length < 3) {
      <div class="flex gap-2 mb-3 overflow-x-auto pb-2 no-scrollbar">
        @for (reply of quickReplies; track reply) {
          <button (click)="sendMessage(reply)" 
                  class="flex-shrink-0 px-3 py-1.5 bg-background-light dark:bg-gray-800 border border-border-color dark:border-gray-600 rounded-full text-xs font-bold text-text-secondary hover:text-primary hover:border-primary hover:bg-primary/5 transition-all whitespace-nowrap">
            {{ reply }}
          </button>
        }
      </div>
    }

    <div class="relative flex items-center gap-2">
      <button class="p-2 text-text-secondary hover:text-primary dark:text-gray-400 dark:hover:text-white transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
        <span class="material-symbols-outlined text-xl">mic</span>
      </button>
      
      <input 
        [(ngModel)]="inputText" 
        (keyup.enter)="sendMessage()"
        type="text" 
        class="flex-1 bg-background-light dark:bg-gray-900 border border-border-color dark:border-gray-600 rounded-xl px-4 py-2.5 text-sm text-text-primary dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all placeholder:text-text-secondary"
        placeholder="اكتب رسالتك هنا..."
      >
      
      <button (click)="sendMessage()" 
              [disabled]="!inputText().trim()"
              class="p-2 bg-primary text-white rounded-xl hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
        <span class="material-symbols-outlined text-xl rtl:rotate-180">send</span>
      </button>
    </div>
  </footer>

</div>